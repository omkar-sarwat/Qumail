# QuMail Cloud Deployment Guide (Render + MongoDB Atlas)

This guide walks through provisioning the free-tier infrastructure required to host the QuMail Secure Email system entirely in the cloud while keeping the Electron frontend local.

## 1. Prerequisites

- GitHub repository access (`omkarsarswat/FULL`)
- Render account (free tier)
- MongoDB Atlas account (free M0 cluster)
- Redis Cloud account (free 30 MB plan)
- Google Cloud project with Gmail API + OAuth consent screen configured

Keep the `.env.template` file nearby and fill in real secrets as you progress.

---

## 2. MongoDB Atlas Setup

1. Create an Atlas organization/project and deploy an **M0 (free) cluster**.
2. Create a database user with **Read/Write** privileges; record the username/password.
3. Under **Network Access**, allow your Render egress IPs or temporarily `0.0.0.0/0` (recommended only for initial testing).
4. Open Atlas → **Deployment → Database** → **Connect → Drivers** and copy the SRV URI. Example:
   ```
   mongodb+srv://qumail_user:superSecret@cluster0.xxxxx.mongodb.net/qumail
   ```
5. Inside the `qumail` database create (or allow the backend to create automatically) the following collections:
   - `users`
   - `drafts`
   - `encryption_metadata`
6. Paste the URI into `.env.template` as `MONGODB_ATLAS_URI`.

---

## 3. Redis Cloud Setup

1. Sign up at [https://redis.com/try-free/](https://redis.com/try-free/).
2. Create a **Fixed 30 MB** free database.
3. Note the **public endpoint**, port, username (often `default`), and the autogenerated password.
4. Compose the connection string:
   ```
   redis://default:password@redis-xxxxx.cloud.redislabs.com:12345
   ```
5. Save it as `REDIS_URL` in `.env.template`.

Both KME services and the backend will use this same Redis pool for the shared key cache.

---

## 4. Prepare Render Environment Variables

Fill `.env.template` with real values:

- `MONGODB_ATLAS_URI`
- `REDIS_URL`
- `GOOGLE_CLIENT_ID` and `GOOGLE_CLIENT_SECRET`
- `GMAIL_SCOPES` (leave default unless permissions change)
- `JWT_SECRET` (random 32+ chars)
- `KME1_URL`, `KME2_URL`, `QUMAIL_API_BASE_URL` (populate after Render services are live)

You can import this file into Render as a **Secret File** or copy/paste variables manually per service.

---

## 5. Deploy with `render.yaml`

1. Commit the `render.yaml` blueprint to the repo root.
2. In Render dashboard go to **Blueprints** → **New Blueprint Instance**.
3. Point it to the GitHub repo and branch (`master`).
4. Render will read `render.yaml` and propose three services:
   - `qumail-kme1`
   - `qumail-kme2`
   - `qumail-backend`
5. For each service, edit the environment variables to use the real secrets from `.env.template` (Render UI lets you override the placeholder values included in the YAML).
6. Confirm build/start commands:
   - KME services: `pip install -r requirements.txt` / `python app.py`
   - Backend: `pip install -r requirements.txt` / `uvicorn main:app --host 0.0.0.0 --port $PORT`
7. Click **Apply**. Render will provision the services on the free tier.

> **Tip:** If you prefer manual service creation, you can create three “Web Service” instances, set `Root Directory` to `next-door-key-simulator` or `qumail-backend` respectively, and reuse the same environment variables.

---

## 6. Capture Service URLs

After deployment succeeds, each Render service exposes a URL, e.g.:
- `https://qumail-kme1.onrender.com`
- `https://qumail-kme2.onrender.com`
- `https://qumail-backend.onrender.com`

Update `.env.template` and Render environment variables for:
- Backend → `KME1_URL`, `KME2_URL`
- Electron app → `QUMAIL_API_BASE_URL`

---

## 7. Configure Electron Client

1. In `qumail-electron/config.production.js` (or environment variables) set:
   ```js
   export const config = {
     apiBaseUrl: 'https://qumail-backend.onrender.com/api/v1',
     oauthRedirect: 'qumail://auth/callback'
   };
   ```
2. Package the Electron app with `npm run build:<platform>` so it targets the cloud backend.

---

## 8. Post-Deployment Verification

Run the `scripts/check_render_deployment.py` (added in the repo) to validate:
- KME `/health` endpoints return 200
- Backend `/health` returns 200
- Key generation and retrieval succeed via Redis
- MongoDB + Redis connectivity checks pass

Command example:
```bash
python scripts/check_render_deployment.py --backend https://qumail-backend.onrender.com --kme1 https://qumail-kme1.onrender.com --kme2 https://qumail-kme2.onrender.com --mongo "mongodb+srv://..." --redis "redis://..."
```

---

## 9. Next Steps

- Enable Render cron job (optional) for metadata cleanup if required.
- Add monitoring/alerts via Render logs + MongoDB Atlas metrics.
- Document the deployed URLs in your internal runbooks.
