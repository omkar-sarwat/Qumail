{
  "meta": {
    "project": "QuMail Secure Email",
    "date": "2025-10-17",
    "prepared_by": "QuMail Development Team"
  },
  "product_overview": "QuMail Secure Email is a quantum-enhanced email platform providing military-grade security integrating Quantum Key Distribution (QKD), Post-Quantum Cryptography (PQC), and traditional encryption methods. It offers four security levels for users to choose optimal protection balancing security, performance, and resource availability, while featuring real-time monitoring and comprehensive audit logging.",
  "core_goals": [
    "Implement ETSI QKD 014 compliant dual Key Management Entities for synchronized quantum key delivery.",
    "Enable information-theoretically secure quantum one-time pad encryption with one-time key use enforcement.",
    "Provide multi-level encryption: quantum OTP, quantum-enhanced AES-256-GCM, post-quantum cryptography, and standard RSA-4096.",
    "Ensure seamless OAuth 2.0 Google Gmail integration for authentication and email handling.",
    "Deliver real-time quantum key status dashboard and comprehensive security audit logging.",
    "Achieve compliance with major regulations including GDPR, HIPAA, PCI-DSS, and SOC 2.",
    "Offer an intuitive, accessible user interface for composing, sending, and reading encrypted emails.",
    "Support scalability to millions of users with high availability and low latency.",
    "Prepare infrastructure for future quantum internet integration and advanced quantum networking."
  ],
  "key_features": [
    "Quantum One-Time Pad Encryption (Level 1) providing perfect secrecy with quantum key distribution.",
    "Quantum-Enhanced AES-256-GCM (Level 2) hybrid encryption using quantum keys for authenticated encryption.",
    "Post-Quantum Cryptography (Level 3) implementing NIST-approved Kyber-1024 and Dilithium-5 algorithms.",
    "Standard RSA-4096 with AES-256-GCM (Level 4) for compatibility with legacy systems.",
    "Dual synchronized Key Management Entities (KME1 and KME2) ensuring identical quantum key pools and one-time use enforcement.",
    "OAuth 2.0 Google authentication with Gmail API integration for user convenience and security.",
    "Email composition and sending interface supporting security level selection and attachment encryption.",
    "Quantum Key Cache on backend enforcing one-time key usage and managing key lifecycle.",
    "Real-time Quantum Status Dashboard showing key availability, entropy, latency and KME health.",
    "Security Audit Logging capturing all security events including key usage and authentication activities.",
    "Comprehensive testing across unit, integration, end-to-end, and penetration scenarios.",
    "GDPR, HIPAA, PCI-DSS compliant with data protection controls and audit trails.",
    "Deployment architectures for scalable cloud and Docker-compose development environments."
  ],
  "user_flow_summary": [
    "User authenticates via Google OAuth 2.0 and grants Gmail API permissions.",
    "User lands on dashboard showing inbox, sent mail, security levels, and quantum key status.",
    "User selects 'Compose Email', fills recipient, subject, selects security level (1-4), writes body, attaches files if any.",
    "System checks quantum key availability and encryption time estimates for chosen security level.",
    "Upon 'Send Encrypted Email', backend requests quantum key from KME1, encrypts email content using selected encryption algorithm.",
    "System posts encrypted email via Gmail API and records metadata with encryption details.",
    "Recipient receives encrypted email; on opening, backend fetches same quantum key from KME2, decrypts content, enforces one-time pad key usage to prevent reuse.",
    "User can view and reply to emails with security metadata displayed (key ID, entropy, encryption method).",
    "Quantum Status Dashboard provides real-time monitoring of key servers, key pools, and encryption statistics.",
    "Security audit logs track all critical operations for compliance and threat detection."
  ],
  "validation_criteria": [
    "All four encryption levels correctly encrypt and decrypt email content as expected.",
    "Quantum keys retrieved from KME1 and KME2 are identical and consumed only once.",
    "OAuth 2.0 flow completes successfully and user sessions are securely maintained.",
    "Email sending and reading workflows show accurate encryption level statuses and error-handling.",
    "Quantum Key Cache enforces strict one-time usage of keys and throws errors on reuse attempts.",
    "Health check endpoints confirm availability of database, KMEs, and security auditor.",
    "Security audit logs capture all key usage, encryption operations, and authentication events.",
    "Performance targets: Level 1 encryption < 2s, Levels 2-4 encryption < 1s, system uptime > 99.9%.",
    "Compliance with data protection regulations (GDPR, HIPAA, PCI-DSS) verified via policy and test cases.",
    "Penetration tests covering injection, XSS, CSRF, token manipulation, and key reuse simulate no vulnerabilities.",
    "Dashboard shows accurate quantum key counts, entropy values, and KME health metrics in real-time.",
    "System passes integration and end-to-end tests simulating user workflows for email composition, encryption, and reading."
  ],
  "code_summary": {
    "tech_stack": [
      "Python 3.12",
      "FastAPI",
      "PostgreSQL",
      "SQLAlchemy",
      "Redis",
      "Alembic",
      "HTTPX",
      "Cryptography",
      "liboqs (Post-Quantum Cryptography)",
      "OAuth 2.0",
      "JWT",
      "ETSI QKD 014"
    ],
    "features": [
      {
        "name": "Health Check",
        "description": "Check backend health status including database, KME servers, and security auditor",
        "files": [
          "app/main.py"
        ],
        "api_doc": {
          "openapi": "3.0.0",
          "paths": {
            "/health": {
              "get": {
                "summary": "Health check endpoint",
                "description": "Returns health status of all services including database, KM servers, and security auditor",
                "responses": {
                  "200": {
                    "description": "Successful response",
                    "content": {
                      "application/json": {
                        "schema": {
                          "type": "object",
                          "properties": {
                            "healthy": {
                              "type": "boolean"
                            },
                            "services": {
                              "type": "object",
                              "properties": {
                                "database": {
                                  "type": "string"
                                },
                                "km_server_1": {
                                  "type": "string"
                                },
                                "km_server_2": {
                                  "type": "string"
                                },
                                "security_auditor": {
                                  "type": "string"
                                }
                              }
                            },
                            "version": {
                              "type": "string"
                            },
                            "timestamp": {
                              "type": "string"
                            },
                            "uptime_seconds": {
                              "type": "number"
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            },
            "/api/v1/health": {
              "get": {
                "summary": "Legacy health endpoint",
                "responses": {
                  "200": {
                    "description": "Simple health status",
                    "content": {
                      "application/json": {
                        "schema": {
                          "type": "object",
                          "properties": {
                            "status": {
                              "type": "string"
                            },
                            "service": {
                              "type": "string"
                            },
                            "version": {
                              "type": "string"
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      },
      {
        "name": "Root API Info",
        "description": "Get API information and available features",
        "files": [
          "app/main.py"
        ],
        "api_doc": {
          "openapi": "3.0.0",
          "paths": {
            "/": {
              "get": {
                "summary": "Root endpoint with API information",
                "responses": {
                  "200": {
                    "description": "API information",
                    "content": {
                      "application/json": {
                        "schema": {
                          "type": "object",
                          "properties": {
                            "service": {
                              "type": "string"
                            },
                            "version": {
                              "type": "string"
                            },
                            "status": {
                              "type": "string"
                            },
                            "environment": {
                              "type": "string"
                            },
                            "documentation": {
                              "type": "string"
                            },
                            "security_levels": {
                              "type": "array",
                              "items": {
                                "type": "string"
                              }
                            },
                            "features": {
                              "type": "array",
                              "items": {
                                "type": "string"
                              }
                            },
                            "timestamp": {
                              "type": "string"
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      },
      {
        "name": "Email Management",
        "description": "Get emails from inbox or sent folder with real database queries",
        "files": [
          "app/main.py",
          "app/models/email.py",
          "app/models/user.py"
        ],
        "api_doc": {
          "openapi": "3.0.0",
          "paths": {
            "/emails": {
              "get": {
                "summary": "Get emails from specified folder",
                "parameters": [
                  {
                    "name": "folder",
                    "in": "query",
                    "schema": {
                      "type": "string",
                      "enum": [
                        "inbox",
                        "sent"
                      ],
                      "default": "inbox"
                    }
                  },
                  {
                    "name": "maxResults",
                    "in": "query",
                    "schema": {
                      "type": "integer",
                      "default": 50
                    }
                  }
                ],
                "responses": {
                  "200": {
                    "description": "List of emails",
                    "content": {
                      "application/json": {
                        "schema": {
                          "type": "object",
                          "properties": {
                            "emails": {
                              "type": "array",
                              "items": {
                                "type": "object",
                                "properties": {
                                  "id": {
                                    "type": "integer"
                                  },
                                  "flow_id": {
                                    "type": "string"
                                  },
                                  "sender": {
                                    "type": "string"
                                  },
                                  "receiver": {
                                    "type": "string"
                                  },
                                  "subject": {
                                    "type": "string"
                                  },
                                  "timestamp": {
                                    "type": "string"
                                  },
                                  "isRead": {
                                    "type": "boolean"
                                  },
                                  "isStarred": {
                                    "type": "boolean"
                                  },
                                  "securityLevel": {
                                    "type": "integer"
                                  },
                                  "direction": {
                                    "type": "string"
                                  },
                                  "isSuspicious": {
                                    "type": "boolean"
                                  }
                                }
                              }
                            },
                            "totalCount": {
                              "type": "integer"
                            },
                            "nextPageToken": {
                              "type": "string"
                            },
                            "userEmail": {
                              "type": "string"
                            }
                          }
                        }
                      }
                    }
                  },
                  "401": {
                    "description": "No authenticated user found"
                  },
                  "500": {
                    "description": "Database error"
                  }
                }
              }
            }
          }
        }
      },
      {
        "name": "Send Quantum Email",
        "description": "Send email with quantum encryption (Level 1-4)",
        "files": [
          "app/main.py",
          "app/services/real_quantum_email.py",
          "app/services/encryption/level1_otp.py"
        ],
        "api_doc": {
          "openapi": "3.0.0",
          "paths": {
            "/emails/send": {
              "post": {
                "summary": "Send email with quantum encryption",
                "requestBody": {
                  "required": true,
                  "content": {
                    "application/json": {
                      "schema": {
                        "type": "object",
                        "properties": {
                          "subject": {
                            "type": "string"
                          },
                          "body": {
                            "type": "string"
                          },
                          "recipient": {
                            "type": "string",
                            "format": "email"
                          },
                          "securityLevel": {
                            "type": "integer",
                            "minimum": 1,
                            "maximum": 4,
                            "default": 2
                          }
                        },
                        "required": [
                          "subject",
                          "body",
                          "recipient"
                        ]
                      }
                    }
                  }
                },
                "responses": {
                  "200": {
                    "description": "Email sent successfully",
                    "content": {
                      "application/json": {
                        "schema": {
                          "type": "object",
                          "properties": {
                            "success": {
                              "type": "boolean"
                            },
                            "emailId": {
                              "type": "integer"
                            },
                            "flowId": {
                              "type": "string"
                            },
                            "encryptionMethod": {
                              "type": "string"
                            },
                            "securityLevel": {
                              "type": "integer"
                            },
                            "entropy": {
                              "type": "number"
                            },
                            "keyId": {
                              "type": "string"
                            },
                            "encryptedSize": {
                              "type": "integer"
                            },
                            "timestamp": {
                              "type": "string"
                            },
                            "message": {
                              "type": "string"
                            }
                          }
                        }
                      }
                    }
                  },
                  "400": {
                    "description": "Recipient and subject are required"
                  },
                  "401": {
                    "description": "No authenticated user found"
                  },
                  "500": {
                    "description": "Failed to send quantum email"
                  }
                }
              }
            }
          }
        }
      },
      {
        "name": "Encryption Status",
        "description": "Get real encryption status from quantum key management entities",
        "files": [
          "app/main.py",
          "app/services/kme_service.py",
          "app/services/real_qkd_client.py"
        ],
        "api_doc": {
          "openapi": "3.0.0",
          "paths": {
            "/encryption/status": {
              "get": {
                "summary": "Get encryption status",
                "responses": {
                  "200": {
                    "description": "Encryption status",
                    "content": {
                      "application/json": {
                        "schema": {
                          "type": "object",
                          "properties": {
                            "kmeStatus": {
                              "type": "array",
                              "items": {
                                "type": "object",
                                "properties": {
                                  "id": {
                                    "type": "string"
                                  },
                                  "name": {
                                    "type": "string"
                                  },
                                  "status": {
                                    "type": "string"
                                  },
                                  "latency": {
                                    "type": "number"
                                  },
                                  "keysAvailable": {
                                    "type": "integer"
                                  },
                                  "maxKeySize": {
                                    "type": "integer"
                                  },
                                  "averageEntropy": {
                                    "type": "number"
                                  },
                                  "keyGenRate": {
                                    "type": "number"
                                  },
                                  "zone": {
                                    "type": "string"
                                  }
                                }
                              }
                            },
                            "quantumKeysAvailable": {
                              "type": "integer"
                            },
                            "encryptionStats": {
                              "type": "object",
                              "properties": {
                                "quantum_otp": {
                                  "type": "integer"
                                },
                                "quantum_aes": {
                                  "type": "integer"
                                },
                                "post_quantum": {
                                  "type": "integer"
                                },
                                "standard_rsa": {
                                  "type": "integer"
                                }
                              }
                            },
                            "entropyStatus": {
                              "type": "string"
                            },
                            "averageEntropy": {
                              "type": "number"
                            },
                            "keyUsage": {
                              "type": "array"
                            },
                            "securityLevels": {
                              "type": "object"
                            },
                            "timestamp": {
                              "type": "string"
                            },
                            "systemStatus": {
                              "type": "string"
                            }
                          }
                        }
                      }
                    }
                  },
                  "500": {
                    "description": "Error retrieving encryption status"
                  }
                }
              }
            }
          }
        }
      },
      {
        "name": "Generate Quantum Keys",
        "description": "Generate quantum keys using QKD KME servers",
        "files": [
          "app/main.py",
          "app/services/kme_service.py"
        ],
        "api_doc": {
          "openapi": "3.0.0",
          "paths": {
            "/api/v1/quantum/generate-keys": {
              "post": {
                "summary": "Generate quantum keys",
                "parameters": [
                  {
                    "name": "count",
                    "in": "query",
                    "schema": {
                      "type": "integer",
                      "default": 10
                    }
                  }
                ],
                "responses": {
                  "200": {
                    "description": "Quantum keys generated",
                    "content": {
                      "application/json": {
                        "schema": {
                          "type": "object",
                          "properties": {
                            "success": {
                              "type": "boolean"
                            },
                            "requestedKeys": {
                              "type": "integer"
                            },
                            "kme1": {
                              "type": "object",
                              "properties": {
                                "generated": {
                                  "type": "integer"
                                },
                                "successful": {
                                  "type": "integer"
                                },
                                "failedKeys": {
                                  "type": "integer"
                                },
                                "successRate": {
                                  "type": "number"
                                }
                              }
                            },
                            "kme2": {
                              "type": "object",
                              "properties": {
                                "generated": {
                                  "type": "integer"
                                },
                                "successful": {
                                  "type": "integer"
                                },
                                "failedKeys": {
                                  "type": "integer"
                                },
                                "successRate": {
                                  "type": "number"
                                }
                              }
                            },
                            "total": {
                              "type": "object",
                              "properties": {
                                "generated": {
                                  "type": "integer"
                                },
                                "successful": {
                                  "type": "integer"
                                },
                                "failedKeys": {
                                  "type": "integer"
                                },
                                "successRate": {
                                  "type": "number"
                                }
                              }
                            },
                            "keyTimestamps": {
                              "type": "array",
                              "items": {
                                "type": "string"
                              }
                            },
                            "generatedAt": {
                              "type": "string"
                            }
                          }
                        }
                      }
                    }
                  },
                  "500": {
                    "description": "Error generating quantum keys"
                  }
                }
              }
            }
          }
        }
      },
      {
        "name": "Quantum Status Dashboard",
        "description": "Redirect to quantum status dashboard HTML page",
        "files": [
          "app/main.py",
          "app/static/quantum_status.html"
        ],
        "api_doc": {
          "openapi": "3.0.0",
          "paths": {
            "/quantum/status": {
              "get": {
                "summary": "Quantum status dashboard",
                "responses": {
                  "307": {
                    "description": "Redirect to static quantum status dashboard"
                  }
                }
              }
            }
          }
        }
      },
      {
        "name": "ETSI QKD 014 Key Cache",
        "description": "In-memory quantum key cache with synchronized key retrieval from KME1 and KME2",
        "files": [
          "app/services/quantum_key_cache.py",
          "app/services/km_client_init.py",
          "app/services/optimized_km_client.py"
        ],
        "api_doc": {
          "description": "Internal service for managing quantum keys with one-time use enforcement. Implements ETSI GS QKD 014 REST API client.",
          "methods": {
            "get_key_for_encryption": {
              "description": "Retrieve quantum key from KME1 for encryption (enc_keys endpoint)",
              "returns": "Quantum key with key_ID"
            },
            "get_key_for_decryption": {
              "description": "Retrieve SAME quantum key from KME2 for decryption (dec_keys endpoint) using key_ID. Enforces one-time use.",
              "params": {
                "key_id": "Unique key identifier from encryption"
              },
              "returns": "Same quantum key from KME2",
              "throws": "SecurityError if key already used (one-time pad violation)"
            }
          }
        }
      },
      {
        "name": "Level 1: Quantum One-Time Pad Encryption",
        "description": "Information-theoretically secure encryption using quantum-distributed keys (Perfect Secrecy)",
        "files": [
          "app/services/encryption/level1_otp.py",
          "app/services/quantum_key_cache.py"
        ],
        "api_doc": {
          "description": "XOR-based encryption with quantum keys from ETSI QKD 014 KMEs. Provides perfect secrecy according to Shannon's theorem.",
          "security_properties": [
            "Perfect secrecy (information-theoretically secure)",
            "Immune to quantum computing attacks",
            "One-time use enforcement",
            "Key length = message length"
          ],
          "methods": {
            "encrypt_otp": {
              "description": "Encrypt plaintext with quantum key via XOR operation",
              "params": {
                "plaintext": "bytes",
                "quantum_key_cache": "QuantumKeyCache instance"
              },
              "returns": {
                "ciphertext": "base64 encoded",
                "key_id": "quantum key identifier",
                "algorithm": "OTP-QKD-ETSI-014",
                "security_level": 1
              }
            },
            "decrypt_otp": {
              "description": "Decrypt ciphertext with same quantum key from KME2",
              "params": {
                "ciphertext": "bytes",
                "key_id": "string",
                "quantum_key_cache": "QuantumKeyCache instance"
              },
              "returns": "decrypted plaintext bytes"
            }
          }
        }
      },
      {
        "name": "Level 2: Quantum-Enhanced AES-256-GCM",
        "description": "Hybrid encryption using quantum keys with AES-256-GCM authenticated encryption",
        "files": [
          "app/services/encryption/level2_quantum_aes.py"
        ],
        "api_doc": {
          "description": "AES-256-GCM with 256-bit quantum key from ETSI QKD 014 KMEs",
          "security_properties": [
            "Quantum-resistant key distribution",
            "Authenticated encryption (AEAD)",
            "NIST approved AES-256 algorithm",
            "Fast encryption speed"
          ]
        }
      },
      {
        "name": "Level 3: Post-Quantum Cryptography",
        "description": "NIST-approved post-quantum algorithms (Kyber-1024 + Dilithium-5)",
        "files": [
          "app/services/encryption/level3_pqc.py"
        ],
        "api_doc": {
          "description": "Post-quantum key encapsulation and digital signatures using liboqs library",
          "algorithms": {
            "KEM": "Kyber-1024 (NIST ML-KEM)",
            "Signature": "Dilithium-5 (NIST ML-DSA)",
            "Symmetric": "AES-256-GCM"
          }
        }
      },
      {
        "name": "Level 4: Standard RSA-4096",
        "description": "Traditional RSA-4096 with AES-256-GCM for maximum compatibility",
        "files": [
          "app/services/encryption/level4_rsa.py"
        ],
        "api_doc": {
          "description": "Standard public-key cryptography with RSA-4096",
          "warning": "Vulnerable to quantum computers. Use Level 1-3 for quantum-safe encryption."
        }
      },
      {
        "name": "Authentication & Authorization",
        "description": "OAuth 2.0 with Google, JWT tokens, session management",
        "files": [
          "app/api/auth.py",
          "app/models/user.py",
          "app/security/oauth.py"
        ],
        "api_doc": {
          "description": "Google OAuth 2.0 authentication flow with Gmail API integration"
        }
      },
      {
        "name": "Security Audit Logging",
        "description": "Comprehensive security incident logging and monitoring",
        "files": [
          "app/services/security_auditor.py",
          "app/models/security_log.py"
        ],
        "api_doc": {
          "description": "Logs all security events including key usage, authentication, encryption operations, and system events"
        }
      },
      {
        "name": "Database Models",
        "description": "SQLAlchemy ORM models for users, emails, quantum keys, and security logs",
        "files": [
          "app/models/user.py",
          "app/models/email.py",
          "app/models/quantum_key.py",
          "app/models/security_log.py"
        ],
        "api_doc": {
          "description": "PostgreSQL database with encrypted storage for sensitive data"
        }
      }
    ]
  }
}
